<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Time Calculator</title>
    <script>
        function calculateTotal() {
            var commuteTime = parseFloat(document.getElementById('commuteTime').value);

            // Convert commute time to hours
            var commuteTimeHours = commuteTime / 60; // convert minutes to hours

            var locationContainers = document.querySelectorAll('.location');
            var totalWorkTimePerLocation = [];
            var totalWorkTime = 0;
            var totalEmployees = 0;

            locationContainers.forEach(function(locationContainer) {
                var locationTimes = locationContainer.querySelectorAll('.timeInput');

                var employeeWorkHours = 0;
                var employeesHTML = "<ul>";

                for (var i = 0; i < locationTimes.length; i += 2) {
                    var startTime = locationTimes[i].value;
                    var endTime = locationTimes[i + 1].value;

                    var startTimeParts = startTime.split(':');
                    var endTimeParts = endTime.split(':');

                    var employeeInTime = new Date(2000, 0, 1, parseInt(startTimeParts[0]), parseInt(startTimeParts[1]));
                    var employeeOutTime = new Date(2000, 0, 1, parseInt(endTimeParts[0]), parseInt(endTimeParts[1]));

                    var employeeWorkTime = (employeeOutTime - employeeInTime) / (1000 * 60 * 60); // Difference in hours
                    employeeWorkHours += employeeWorkTime;
                    totalEmployees++;

                    var employeeName = locationContainer.querySelector('.locationEmployee').value;
                    employeesHTML += "<li>" + employeeName + ": " + employeeWorkTime.toFixed(2) + " hours (Start: " + startTime + ", Finish: " + endTime + ")</li>";
                }
                employeesHTML += "</ul>";

                // Total work time for the location
                totalWorkTime += employeeWorkHours;
                totalWorkTimePerLocation.push({ workHours: employeeWorkHours, employeesHTML: employeesHTML }); // Store total work time and employees HTML for this location
            });

            var totalCommuteTime = 0;

            locationContainers.forEach(function(locationContainer, index) {
                var locationWorkTime = totalWorkTimePerLocation[index].workHours;
                var locationCommuteTime = (locationWorkTime / totalWorkTime) * commuteTimeHours;
                totalCommuteTime += locationCommuteTime;
            });

            // Display total work time per location
            var totalWorkTimeHTML = "<ul>";
            totalWorkTimePerLocation.forEach(function(locationData, index) {
                var locationName = document.getElementById('locationName-' + (index + 1)).value;
                totalWorkTimeHTML += "<li>" + locationName + ": " + (locationData.workHours + (locationData.workHours / totalWorkTime * totalCommuteTime)).toFixed(2) + " hours";
                totalWorkTimeHTML += locationData.employeesHTML;
                totalWorkTimeHTML += "</li>";
            });
            totalWorkTimeHTML += "</ul>";

            // Total commute time
            totalWorkTimeHTML += "<h3>Total Commute Time:</h3>";
            totalWorkTimeHTML += "<p>" + totalCommuteTime.toFixed(2) + " hours</p>";

            document.getElementById('totalWorkTime').innerHTML = totalWorkTimeHTML;

            // Return calculations as message
            return totalWorkTimeHTML;
        }

        function addEmployee(container) {
            var employeeContainer = container.previousElementSibling;
            var employeeInput = document.createElement('input');
            employeeInput.type = 'text';
            employeeInput.placeholder = 'Employee';
            employeeInput.classList.add('locationEmployee');
            employeeInput.value = '';

            var timeInput1 = document.createElement('input');
            timeInput1.type = 'time';
            timeInput1.classList.add('timeInput');
            timeInput1.value = '';

            var timeInput2 = document.createElement('input');
            timeInput2.type = 'time';
            timeInput2.classList.add('timeInput');
            timeInput2.value = '';

            var removeButton = document.createElement('button');
            removeButton.textContent = 'Remove Employee';
            removeButton.onclick = function() {
                employeeContainer.removeChild(employeeInput);
                employeeContainer.removeChild(timeInput1);
                employeeContainer.removeChild(timeInput2);
                employeeContainer.removeChild(removeButton);
            };

            employeeContainer.appendChild(document.createElement('br'));
            employeeContainer.appendChild(employeeInput);
            employeeContainer.appendChild(timeInput1);
            employeeContainer.appendChild(document.createTextNode(" - "));
            employeeContainer.appendChild(timeInput2);
            employeeContainer.appendChild(removeButton);
        }

        function addLocation() {
            var locationContainer = document.getElementById('locationContainer');
            var locationNumber = locationContainer.childElementCount + 1;

            var locationDiv = document.createElement('div');
            locationDiv.innerHTML = '<h3>Location ' + locationNumber + ':</h3>' +
                '<div class="locationNameContainer">' +
                '<label for="locationName-' + locationNumber + '">Location Name:</label>' +
                '<input type="text" id="locationName-' + locationNumber + '" placeholder="Enter location name" value="">' +
                '</div>' +
                '<div class="employeeContainer">' +
                '<input type="text" placeholder="Employee" class="locationEmployee" value="">' +
                '<input type="time" class="timeInput" value=""> - <input type="time" class="timeInput" value=""> ' +
                '</div>' +
                '<button onclick="addEmployee(this)">Add Employee</button>';
            locationDiv.classList.add('location');
            locationContainer.appendChild(locationDiv);
        }

        function submitForm() {
            var email = document.getElementById('email').value;
            var reportDate = document.getElementById('reportDate').value;
            var message = document.getElementById('message').value.replace(/\n/g, "<br>");
            var calculations = calculateTotal(); // Include calculations in the message

            // Check if required fields (email and reportDate) are filled
            if (!email || !reportDate) {
                alert('ERROR: Please fill in all required fields.');
                return;
            }

            // Construct message object
            var messageObject = {
                "email": email,
                "reportDate": reportDate,
                "message": "<br><br><b>" + message + "</b><br><br>", // Wrap the message with <b> tags
                "calculations": calculations
            };

            // Send POST request
            fetch('https://prod-167.westus.logic.azure.com:443/workflows/7a51e8f060734770978bf978815168ef/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=oxcvUje69kvCLan7VpvrzE2P-UxvUmmV8oGsRePSz_4', {
                method: 'POST',
                body: JSON.stringify(messageObject),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(function(response) {
                if (response.ok) {
                    alert('Message submitted successfully!');
                    resetForm(); // Reset the form
                } else {
                    alert('Error submitting message. Please try again later.');
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('Error submitting message. Please try again later.');
            });
        }

        function resetForm() {
            // Reset form to initial state
            document.getElementById('locationContainer').innerHTML = '';
            addLocation(); // Add default location
            document.getElementById('commuteTime').value = ''; // Reset commute time
            document.getElementById('totalWorkTime').innerHTML = ''; // Clear total work time
            document.getElementById('message').value = ''; // Reset message field
        }
    </script>
</head>
<body>
<h2>Work Time Calculator</h2>
<div>
    <label for="email">Email Address:</label>
    <input type="email" id="email" placeholder="Enter email address">
</div>
<div>
    <label for="reportDate">Date of Report:</label>
    <input type="date" id="reportDate" value="">
</div>
<div id="locationContainer">
    <div class="location">
        <h3>Location 1:</h3>
        <div class="locationNameContainer">
            <label for="locationName-1">Location Name:</label>
            <input type="text" id="locationName-1" placeholder="Enter location name" value="">
        </div>
        <div class="employeeContainer">
            <input type="text" placeholder="Employee" class="locationEmployee" value="">
            <input type="time" class="timeInput" value=""> - <input type="time" class="timeInput" value=""> 
        </div>
        <button onclick="addEmployee(this)">Add Employee</button>
    </div>
</div>
<button onclick="addLocation()" style="margin-bottom: 10px;">Add Location</button>
<div>
    <label for="commuteTime">Commute Time (minutes):</label>
    <input type="number" id="commuteTime" placeholder="Commute time">
</div>
<button onclick="calculateTotal()">Calculate Total</button>
<br><br>
<div>
    <h3>Total Work Time per Location:</h3>
    <div id="totalWorkTime"></div>
</div>
<br>
<div>
    <h3>Message to Office:</h3>
    <textarea id="message" rows="8" cols="50"></textarea> <!-- Increased rows for larger message -->
</div>
<button onclick="submitForm()">Submit</button>
</body>
</html>
